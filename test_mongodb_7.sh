#!/bin/bash

# –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ MongoDB 7.0 —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

set -euo pipefail

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

echo "============================================================================="
echo "üß™ –¢–µ—Å—Ç MongoDB 7.0 —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
echo "============================================================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Ubuntu
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Ubuntu..."
echo "–í–µ—Ä—Å–∏—è: $(lsb_release -rs)"
echo "–ö–æ–¥–æ–≤–æ–µ –∏–º—è: $(lsb_release -cs)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É..."
if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
    log_success "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    log_error "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ MongoDB GPG –∫–ª—é—á–∞
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ MongoDB 7.0 GPG –∫–ª—é—á–∞..."
if curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc >/dev/null 2>&1; then
    log_success "GPG –∫–ª—é—á MongoDB 7.0 –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    log_error "GPG –∫–ª—é—á MongoDB 7.0 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ MongoDB 7.0 —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
REPO_URL="https://repo.mongodb.org/apt/ubuntu $(lsb_release -cs)/mongodb-org/7.0"
if curl -fsSL "$REPO_URL" >/dev/null 2>&1; then
    log_success "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π MongoDB 7.0 –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    log_warning "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π MongoDB 7.0 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è $(lsb_release -cs)"
    log_info "–ü–æ–ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π URL..."
    
    # –ü–æ–ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π URL –¥–ª—è Ubuntu 24.04
    if [[ "$(lsb_release -cs)" == "noble" ]]; then
        ALT_REPO_URL="https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0"
        if curl -fsSL "$ALT_REPO_URL" >/dev/null 2>&1; then
            log_success "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω (jammy)"
            echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Ubuntu jammy (22.04) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è noble (24.04)"
        else
            log_error "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Ç–∞–∫–∂–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        fi
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö MongoDB —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö MongoDB —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤..."
if ls /etc/apt/sources.list.d/mongodb-org-*.list 2>/dev/null; then
    log_warning "–ù–∞–π–¥–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ MongoDB —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:"
    ls -la /etc/apt/sources.list.d/mongodb-org-*.list
else
    log_info "–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ MongoDB —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

echo
echo "============================================================================="
log_success "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω"
echo "=============================================================================" 